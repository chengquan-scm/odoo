# -*- coding: utf-8 -*-
"""
ç™½ç­ ï¼š
    - æ ‡å‡†å·¥æ—¶(æ­£å¸¸å·¥èµ„): å‘¨ä¸€åˆ°å‘¨å…­ 7:00 - 16:00 æ‰£é™¤ä¸­åˆ 12:00 - 13:00 åƒé¥­ä¸€å°æ—¶
    - å·¥ä½œæ—¥åŠ ç­ï¼ˆ1.5å€ï¼‰: 16:00 - 19:00
    - å‘¨æœ«åŠ ç­(2å€): å·¥æ—¶è€ƒå‹¤ä¸ºå‡†ï¼Œå‚è€ƒå·¥æ—¶ 7:00 - 19:00  æ‰£é™¤ä¸­åˆ 12:00 - 13:00 åƒé¥­ä¸€å°æ—¶
    - èŠ‚å‡æ—¥åŠ ç­(3å€): å·¥æ—¶è€ƒå‹¤ä¸ºå‡†ï¼Œå‚è€ƒå·¥æ—¶  7:00 - 19:00  æ‰£é™¤ä¸­åˆ 12:00 - 13:00 åƒé¥­ä¸€å°æ—¶
å¤œç­ï¼š
    - 19:00â€“22:00 æ­£å¸¸å¤œç­ï¼ˆç³»æ•°1ï¼‰
    - 22:00â€“03:00 æ·±å¤œå¤œç­ï¼ˆç³»æ•°1.3ï¼‰
    - 03:00â€“07:00 å¤œç­åŠ ç­ï¼ˆç³»æ•°2.1ï¼‰

è¿˜æœ‰ä¸ªæ€è·¯ï¼Œ ç›´æ¥å°†æ ‡å‡†å·¥æ—¶æ”¹ä¸ºå‡å»å¸¦è–ªä¼‘å‡çš„8å°æ—¶ï¼Œ
å¦å¤–ï¼Œ å·¥ä½œæ—¥ä¸Šæ»¡8å°æ—¶ç®—å…¨å‹¤ï¼Œ è¿˜æ˜¯11å°æ—¶ç®—å…¨å‹¤

åº”è¯¥å»æ‰å­—æ®µ æ˜¯å¦å…¨å‹¤å’Œ å¸¦è–ªä¼‘å‡å·²ç”¨
ç„¶ååŠ ä¸¤ä¸ªå­—æ®µ
    - æ—¶æ–° = åŸºç¡€å·¥èµ„(414W)/æ ‡å‡†å·¥æ—¶
    - å‡ºå‹¤ç‡ = ï¼ˆç™½ç­ + å¤œç­ + æ·±å¤œç­ï¼‰/ æ ‡å‡†å·¥æ—¶ - 8ï¼ˆå¸¦è–ªä¼‘å‡ï¼‰
        - ç®¡ç†è¡¥è´´ï¼ŒæŠ€æœ¯è¡¥è´´ç­‰ä¹Ÿä¼šéšç€å‡ºå‹¤ç‡æµ®åŠ¨
    - å¸¦è–ªä¼‘å‡å‰©ä½™å°æ—¶æ•°
"""





from odoo import models, fields, api
from datetime import datetime, timedelta, time
import pytz


class HrPayslip(models.Model):
    _inherit = 'hr.payslip'

    # ç™½ç­å­—æ®µï¼ˆåŸæœ‰ï¼‰
    standard_hours = fields.Float("æ ‡å‡†å·¥æ—¶")
    worked_hours = fields.Float("å®é™…å·¥æ—¶")
    ot_weekday = fields.Float("å·¥ä½œæ—¥åŠ ç­")  # 16:00-19:00
    ot_weekend = fields.Float("å‘¨æœ«åŠ ç­")
    ot_holiday = fields.Float("èŠ‚å‡æ—¥åŠ ç­")

    # å¤œç­å­—æ®µï¼ˆå°æ—¶æ•°ï¼Œä¸å«ç³»æ•°ï¼‰
    night_regular = fields.Float("å¤œç­ 19-22")
    night_deep = fields.Float("æ·±å¤œç­ 22-03")
    night_ot = fields.Float("å¤œç­åŠ ç­ 03-07")

    # æ–°å¢å­—æ®µ - è¿™äº›å­—æ®µä¼šåœ¨ compute_attendance_hours ä¸­ç›´æ¥è®¡ç®—å¹¶èµ‹å€¼
    attendance_rate = fields.Float("å‡ºå‹¤ç‡")
    remaining_paid_leave_hours = fields.Float("å¸¦è–ªä¼‘å‡å‰©ä½™å°æ—¶æ•°")
    # æ–°å¢å­—æ®µ
    night_full_days = fields.Integer("å¤œç­æ»¡å‹¤å¤©æ•°", compute="_compute_night_full_days", store=True)


    def compute_sheet(self):
        """è¦†ç›– compute_sheetï¼Œå…ˆè®¡ç®—å·¥æ—¶å’ŒåŠ ç­ï¼ˆå°æ—¶æ•°ï¼‰ï¼Œå†èµ°åŸè®¡ç®—"""
        print(f"[HrPayslip][{self.employee_id.name}] >>> è°ƒç”¨ compute_sheetï¼Œå¼€å§‹è®¡ç®—å·¥æ—¶å’ŒåŠ ç­")
        self.compute_attendance_hours()
        self._compute_night_full_days()  # è®¡ç®—å¤œç­å¤©æ•°
        return super().compute_sheet()

    # ----------------- helper -----------------
    def _ensure_utc(self, dt):
        if dt is None:
            return None
        if isinstance(dt, datetime):
            if dt.tzinfo is None:
                return pytz.UTC.localize(dt)
            return dt.astimezone(pytz.UTC)
        return None

    def _overlap_seconds(self, a_start, a_end, b_start, b_end):
        latest = max(a_start, b_start)
        earliest = min(a_end, b_end)
        diff = (earliest - latest).total_seconds()
        return max(0.0, diff)

    def _calculate_hours_interval(self, a_start, a_end, interval_start, interval_end):
        """è¿”å› a ä¸ interval çš„é‡å å°æ—¶æ•°ï¼ˆä¼ å…¥ dt å¸¦ tzinfoï¼‰"""
        secs = self._overlap_seconds(a_start, a_end, interval_start, interval_end)
        return secs / 3600.0

    def _calculate_hours_for_day(self, check_in_utc, check_out_utc, tz, current_day, is_night=False):
        """
        è®¡ç®—æŸä¸€å¤©çš„å·¥ä½œæ—¶é•¿ï¼ˆç”¨äºç™½ç­åŸºç¡€ç»Ÿè®¡ï¼‰ï¼Œç™½ç­æ‰£åˆä¼‘ 12:00-13:00ï¼Œå¤œç­ä¸æ‰£åˆä¼‘ã€‚
        ä¼ å…¥ check_in_utc / check_out_utc ä¸º UTC aware datetimeã€‚
        è¿”å›è¯¥ day ä¸è€ƒå‹¤è®°å½•çš„å°æ—¶æ•°ï¼ˆè‹¥è€ƒå‹¤è·¨å¤šå¤©ï¼Œå¤–å±‚ä¼šæ‹†æ—¥å¤„ç†ï¼‰ã€‚
        """
        ci_local = check_in_utc.astimezone(tz)
        co_local = check_out_utc.astimezone(tz)

        day_start = tz.localize(datetime.combine(current_day, time.min))
        day_end = tz.localize(datetime.combine(current_day, time.max))
        work_start = max(ci_local, day_start)
        work_end = min(co_local, day_end)
        if work_end <= work_start:
            return 0.0

        total_seconds = (work_end - work_start).total_seconds()
        if not is_night:
            # æ‰£åˆä¼‘ 12:00-13:00
            lunch_start = tz.localize(datetime.combine(current_day, time(12, 0)))
            lunch_end = tz.localize(datetime.combine(current_day, time(13, 0)))
            lunch_overlap = max(0, min(work_end, lunch_end).timestamp() - max(work_start, lunch_start).timestamp())
            return max(0, total_seconds - lunch_overlap) / 3600.0
        else:
            return total_seconds / 3600.0

    def _compute_night_full_days(self):
        """ç»Ÿè®¡å¤œç­ >= 8.5h çš„å¤©æ•°"""
        for slip in self:
            emp = slip.employee_id
            tz_name = emp.user_id.tz or self.env.user.tz or 'UTC'
            tz = pytz.timezone(tz_name)
            Attendance = self.env['hr.attendance']

            full_night_days = 0
            day_count = (slip.date_to - slip.date_from).days + 1
            for i in range(day_count):
                current_day = slip.date_from + timedelta(days=i)
                day_start = tz.localize(datetime.combine(current_day, time.min))
                day_end = tz.localize(datetime.combine(current_day, time.max))

                # æŸ¥è¯¢å½“å¤©è€ƒå‹¤
                attendances = Attendance.search([
                    ('employee_id', '=', emp.id),
                    ('check_in', '<=', day_end.astimezone(pytz.UTC)),
                    ('check_out', '>=', day_start.astimezone(pytz.UTC)),
                ])

                night_hours = 0.0
                for att in attendances:
                    if not att.check_in or not att.check_out:
                        continue
                    ci = att.check_in.astimezone(tz)
                    co = att.check_out.astimezone(tz)

                    # å¤œç­ä¸‰æ®µï¼š19-22, 22-03, 03-07
                    nr_start = tz.localize(datetime.combine(current_day, time(19, 0)))
                    nr_end = tz.localize(datetime.combine(current_day, time(22, 0)))
                    nd_start = tz.localize(datetime.combine(current_day, time(22, 0)))
                    nd_end = tz.localize(datetime.combine(current_day + timedelta(days=1), time(3, 0)))
                    no_start = tz.localize(datetime.combine(current_day + timedelta(days=1), time(3, 0)))
                    no_end = tz.localize(datetime.combine(current_day + timedelta(days=1), time(7, 0)))

                    # å åŠ å¤œç­å°æ—¶æ•°ï¼ˆä¸ä¹˜ç³»æ•°ï¼‰
                    night_hours += slip._calculate_hours_interval(ci, co, nr_start, nr_end)
                    night_hours += slip._calculate_hours_interval(ci, co, nd_start, nd_end)
                    night_hours += slip._calculate_hours_interval(ci, co, no_start, no_end)

                if night_hours >= 8.5:
                    full_night_days += 1

            slip.night_full_days = full_night_days
            print(f"å¤œç­å¤©æ•°ï¼š {full_night_days}")

    def compute_attendance_hours(self):
        """
        é€æ—¥ç»Ÿè®¡å·¥æ—¶ï¼ˆå°æ—¶ï¼‰ï¼Œç™½ç­/å¤œç­çš„å°æ—¶æ•°éƒ½åªè®°å½•å°æ—¶ï¼ˆä¸ä¹˜ä»»ä½•å·¥èµ„ç³»æ•°ï¼‰ã€‚
        """
        print("[HrPayslip] >>> è°ƒç”¨ compute_attendance_hours æ–¹æ³•")
        Attendance = self.env['hr.attendance']

        for slip in self:
            emp = slip.employee_id
            emp_name = emp.name or 'Unknown'
            print(f"\n[HrPayslip][{emp_name}] === å¼€å§‹è®¡ç®—å·¥æ—¶: {slip.date_from} ~ {slip.date_to} ===")

            # åˆå§‹åŒ–æ±‡æ€»å­—æ®µ
            standard_hours = 0.0
            worked_hours = 0.0
            ot_weekday = 0.0
            ot_weekend = 0.0
            ot_holiday = 0.0
            night_regular = 0.0
            night_deep = 0.0
            night_ot = 0.0
            attendance_rate = 0.0
            remaining_paid_leave_hours = 0.0

            # æ—¶åŒº
            emp_tz_name = emp.user_id.tz or self.env.user.tz or 'UTC'
            tz = pytz.timezone(emp_tz_name)

            # å…¬å…±å‡æœŸï¼ˆæŒ‰ employee æä¾›çš„æ–¹æ³•ï¼‰
            holiday_dates = set()
            try:
                public_holidays_data = emp.get_public_holidays_data(slip.date_from, slip.date_to)
                for bh in public_holidays_data:
                    try:
                        start = datetime.fromisoformat(bh['start']).date()
                        end = datetime.fromisoformat(bh['end']).date()
                        for dd in range((end - start).days + 1):
                            holiday_dates.add(start + timedelta(days=dd))
                    except Exception:
                        continue
            except Exception as e:
                print(f"[HrPayslip][{emp_name}] âŒ è·å–å…¬å…±å‡æœŸå¤±è´¥: {e}")
                holiday_dates = set()

            print(f"[HrPayslip][{emp_name}] å…¬å…±å‡æ—¥: {sorted(list(holiday_dates))}")

            # è®¡ç®—ç™½ç­æ ‡å‡†å·¥æ—¶ï¼ˆå‘¨ä¸€ï½å‘¨å…­ï¼Œæ’é™¤å‘¨æ—¥å’Œå…¬å…±å‡æ—¥ï¼‰
            day_count = (slip.date_to - slip.date_from).days + 1
            for i in range(day_count):
                d = slip.date_from + timedelta(days=i)
                if d.weekday() != 6:
                    standard_hours += 8.0
            print(f"[HrPayslip][{emp_name}] ç™½ç­æ ‡å‡†å·¥æ—¶(å‘¨æœŸå†…): {standard_hours}h")

            # æŸ¥è¯¢è€ƒå‹¤è®°å½•ï¼ˆUTCï¼‰
            q_start = pytz.UTC.localize(datetime.combine(slip.date_from, time.min))
            q_end = pytz.UTC.localize(datetime.combine(slip.date_to, time.max))
            attendances = Attendance.search([
                ('employee_id', '=', emp.id),
                ('check_in', '<=', q_end),
                ('check_out', '>=', q_start),
            ])
            print(f"[HrPayslip][{emp_name}] æ‰¾åˆ°è€ƒå‹¤è®°å½•: {len(attendances)} æ¡")

            # è®°å½•æ¯å¤©å°æ—¶æ•°ç”¨äºæ±‡æ€»/æ—¥å¿—
            per_day_info = {}  # date -> dict with details
            # åˆå§‹åŒ– per_day_info
            for i in range(day_count):
                current_day = slip.date_from + timedelta(days=i)
                per_day_info[current_day] = {
                    'date': current_day,
                    'is_holiday': (current_day in holiday_dates),
                    'is_sunday': (current_day.weekday() == 6),
                    'white_worked': 0.0,
                    'white_ot16_19': 0.0,  # å·¥ä½œæ—¥åŠ ç­ 16:00-19:00ï¼ˆæŒ‰å¤©ç´¯è®¡ï¼‰
                    'white_ot_weekend': 0.0,
                    'white_ot_holiday': 0.0,
                    'night_19_22': 0.0,
                    'night_22_03': 0.0,
                    'night_03_07': 0.0,
                    'has_attendance': False,  # å½“å¤©æ˜¯å¦æœ‰è€ƒå‹¤
                }

            # éå†æ¯æ¡è€ƒå‹¤ï¼Œæ‹†åˆ†åˆ°æ¯å¤©å¹¶ç»Ÿè®¡ç™½ç­/å¤œç­å„æ®µçš„å°æ—¶
            for att in attendances:
                if not att.check_in or not att.check_out:
                    continue
                ci_utc = self._ensure_utc(att.check_in)
                co_utc = self._ensure_utc(att.check_out)
                if co_utc <= ci_utc:
                    continue

                # å°†è€ƒå‹¤æŒ‰æœ¬åœ°æ—¶åŒºæ‹†åˆ°å¯¹åº”æ—¥æœŸæ®µï¼ˆä½¿ç”¨ ci_local/co_localï¼‰
                ci_local = ci_utc.astimezone(tz)
                co_local = co_utc.astimezone(tz)
                start_date = ci_local.date()
                end_date = co_local.date()
                for d_off in range((end_date - start_date).days + 1):
                    current_day = start_date + timedelta(days=d_off)
                    if current_day < slip.date_from or current_day > slip.date_to:
                        continue

                    info = per_day_info.get(current_day)
                    if info is None:
                        # å¦‚æœè¶…å‡ºèŒƒå›´åˆ™è·³è¿‡
                        continue

                    info['has_attendance'] = True  # æ ‡è®°è¯¥å¤©æœ‰è€ƒå‹¤

                    # ä¸ºå½“å‰_day ç”Ÿæˆæœ¬æ—¥çš„ day-intervalï¼ˆæœ¬åœ°æ—¶åŒºï¼‰
                    day_local_start = tz.localize(datetime.combine(current_day, time.min))
                    day_local_end = tz.localize(datetime.combine(current_day, time.max))

                    # è®¡ç®—ç™½ç­ï¼ˆ7:00-16:00 ä¸ºæ ‡å‡†ï¼›16:00-19:00 ä¸ºå·¥ä½œæ—¥åŠ ç­ï¼‰
                    # ç”¨è€ƒå‹¤åŸå§‹åŒºé—´çš„ä¸å½“å¤©åŒºé—´çš„äº¤é›†ï¼ˆlocalï¼‰
                    att_start = max(ci_local, day_local_start)
                    att_end = min(co_local, day_local_end)
                    if att_end <= att_start:
                        continue

                    # ç™½ç­æ ‡å‡†æ—¶é—´æ®µï¼ˆ7:00-16:00ï¼‰ï¼Œæ³¨æ„åˆä¼‘ 12:00-13:00 è¦åœ¨æœ€ç»ˆç»Ÿè®¡æ—¶æ‰£ä¸€æ¬¡
                    std_start = tz.localize(datetime.combine(current_day, time(7, 0)))
                    std_end = tz.localize(datetime.combine(current_day, time(16, 0)))
                    std_overlap = self._calculate_hours_interval(att_start, att_end, std_start, std_end)
                    # æ‰£åˆä¼‘ 12-13 åœ¨ later stepï¼ˆå¦‚æœ std_overlap åŒ…å«åˆä¼‘ä¼šå‡æ‰ï¼‰
                    # è¿™é‡Œæˆ‘ä»¬ç›´æ¥è®¡ç®—åŒ…å«åˆä¼‘çš„æ—¶æ®µï¼Œå†ç”¨ä¸“é—¨é€»è¾‘æ‰£åˆä¼‘
                    # 16:00-19:00 å·¥ä½œæ—¥åŠ ç­ï¼ˆä¸æ‰£åˆä¼‘ï¼‰
                    ot_start = tz.localize(datetime.combine(current_day, time(16, 0)))
                    ot_end = tz.localize(datetime.combine(current_day, time(19, 0)))
                    ot_overlap = self._calculate_hours_interval(att_start, att_end, ot_start, ot_end)

                    # å‘¨æœ«/èŠ‚å‡æ—¥è§†ä¸ºå‘¨æœ«/èŠ‚å‡æ—¥åŠ ç­ï¼š7:00-16:00ï¼ˆåŒæ ·æ‰£åˆä¼‘ï¼‰
                    wk_start = tz.localize(datetime.combine(current_day, time(7, 0)))
                    wk_end = tz.localize(datetime.combine(current_day, time(16, 0)))
                    wk_overlap = self._calculate_hours_interval(att_start, att_end, wk_start, wk_end)

                    # ç»Ÿè®¡åˆ° infoï¼ˆæ³¨æ„ï¼šå¦‚æœæ˜¯èŠ‚å‡æ—¥æˆ–å‘¨æ—¥ï¼Œstd_overlap/ wk_overlap åº”åˆ†åˆ«åŠ åˆ° holiday/weekendï¼‰
                    if info['is_holiday']:
                        info['white_ot_holiday'] += wk_overlap
                    elif info['is_sunday']:
                        info['white_ot_weekend'] += wk_overlap
                    else:
                        # å·¥ä½œæ—¥ï¼Œstd_overlap ä¸º 7-16 åŒºé—´å†…å·¥ä½œå°æ—¶ï¼ˆå«åˆä¼‘ï¼‰ï¼Œç¨åæ‰£åˆä¼‘
                        info['white_worked'] += std_overlap
                        info['white_ot16_19'] += ot_overlap

                    # å¤œç­ç»Ÿè®¡ï¼ˆä»¥ 19:00(current_day) - 07:00(next_day) ä¸ºæ•´ä½“ï¼Œå†æ‹†ä¸‰æ®µï¼‰
                    # ä¸‰æ®µï¼š19-22, 22-03(next day), 03-07(next day)
                    nr_start = tz.localize(datetime.combine(current_day, time(19, 0)))
                    nr_end = tz.localize(datetime.combine(current_day, time(22, 0)))
                    nd_start = tz.localize(datetime.combine(current_day, time(22, 0)))
                    nd_end = tz.localize(datetime.combine(current_day + timedelta(days=1), time(3, 0)))
                    no_start = tz.localize(datetime.combine(current_day + timedelta(days=1), time(3, 0)))
                    no_end = tz.localize(datetime.combine(current_day + timedelta(days=1), time(7, 0)))

                    info['night_19_22'] += self._calculate_hours_interval(ci_local.astimezone(tz),
                                                                          co_local.astimezone(tz), nr_start, nr_end)
                    info['night_22_03'] += self._calculate_hours_interval(ci_local.astimezone(tz),
                                                                          co_local.astimezone(tz), nd_start, nd_end)
                    info['night_03_07'] += self._calculate_hours_interval(ci_local.astimezone(tz),
                                                                          co_local.astimezone(tz), no_start, no_end)

            # è®°å½•éæ»¡å‹¤æƒ…å†µï¼ˆç™½ç­/å¤œç­éƒ½é€‚ç”¨ï¼‰
            absent_days = []
            total_std_missing = 0.0
            total_ot_missing = 0.0

            for current_day, info in per_day_info.items():
                if info['is_holiday'] or info['is_sunday']:
                    continue

                # ç™½ç­æ»¡å‹¤æ ‡å‡†ï¼š7:00-16:00 - 1håˆä¼‘ + 16:00-19:00åŠ ç­ = 11h
                white_full_hours = 11.0
                white_worked = info['white_worked']
                white_ot16_19 = info['white_ot16_19']

                # å¤œç­æ»¡å‹¤æ ‡å‡†ï¼š19:00-07:00 = 12h
                night_full_hours = 12.0
                night_worked = info['night_19_22'] + info['night_22_03'] + info['night_03_07']

                # åˆ¤æ–­æ˜¯å¦æ»¡å‹¤
                full_white = (white_worked + white_ot16_19) >= white_full_hours
                full_night = night_worked >= night_full_hours

                if not (full_white or full_night):
                    absent_days.append(current_day)

                    # è®¡ç®—ç¼ºå‹¤å°æ—¶
                    white_missing = max(0.0, white_full_hours - (white_worked + white_ot16_19))
                    night_missing = max(0.0, night_full_hours - night_worked)

                    total_std_missing += white_missing
                    total_ot_missing += night_missing

                    print(f"[HrPayslip][{emp.name}] â— {current_day} éæ»¡å‹¤ï¼š"
                          f"ç™½ç­ç¼ºå‹¤ {round(white_missing, 2)}h, å¤œç­ç¼ºå‹¤ {round(night_missing, 2)}h, "
                          f"å®é™…ç™½ç­ {round(white_worked, 2)}h + 16-19åŠ ç­ {round(white_ot16_19, 2)}h, "
                          f"å¤œç­ {round(night_worked, 2)}h")

            if absent_days:
                print(f"[HrPayslip][{emp.name}] â— æ€»éæ»¡å‹¤æ—¥æœŸ: {sorted(absent_days)}")
                print(
                    f"[HrPayslip][{emp.name}] â— æ€»ç¼ºå‹¤å°æ—¶ï¼šæ ‡å‡†å·¥æ—¶ {round(total_std_missing, 2)}h, åŠ ç­ {round(total_ot_missing, 2)}h")
            else:
                print(f"[HrPayslip][{emp.name}] âœ… å…¨å‹¤")

            # åå¤„ç†æ¯å¤©ä¿¡æ¯ï¼šæ‰£åˆä¼‘
            for current_day, info in sorted(per_day_info.items()):

                # æ‰£åˆä¼‘ï¼ˆå¦‚æœç™½ç­æ®µè¦†ç›–åˆä¼‘åˆ™æ‰£ 1 å°æ—¶ï¼‰
                # åˆä¼‘ä¸º 12:00-13:00ï¼Œå½“ç™½ç­ 7-16 æ—¶é—´æ®µå†…å®é™…è¦†ç›–äº†åˆä¼‘åˆ™éœ€è¦æ‰£å»
                # è®¡ç®—å½“å¤©ç™½ç­7-16è¦†ç›–å†…åˆä¼‘ overlap
                if not info['is_holiday'] and not info['is_sunday']:
                    # 7-16 çš„å®é™… white_worked ï¼ˆç›®å‰åŒ…å«åˆä¼‘é‡å éƒ¨åˆ†ï¼‰ï¼Œéœ€è¦æ‰£æ‰åˆä¼‘åœ¨ std åŒºé—´çš„é‡å 
                    # æ„é€ åˆä¼‘åŒºé—´
                    lunch_start = tz.localize(datetime.combine(info['date'], time(12, 0)))
                    lunch_end = tz.localize(datetime.combine(info['date'], time(13, 0)))
                    # å¦‚æœç™½_worked åœ¨ 7-16 å†…æœ‰è¦†ç›–åˆä¼‘ï¼Œåˆ™å‡å»1å°æ—¶ï¼ˆæˆ–å®é™…è¦†ç›–å°æ—¶ï¼‰
                    # ç”±äºæˆ‘ä»¬ç´¯è®¡çš„æ˜¯é‡å å°æ—¶ï¼Œè‹¥ç™½ç­æ®µè¦†ç›–åˆä¼‘åˆ™æœ€å°‘è¦†ç›–éƒ¨åˆ†ä¼šè¢«è®¡å…¥ white_workedï¼Œ
                    # æˆ‘ä»¬å°è¯•ä»¥ç®€å•ä¸”ç¨³å¥çš„æ–¹å¼ï¼šè‹¥ç™½ç­7-16ç´¯è®¡å°æ—¶ >= ( (13-7)=6 ) åˆ™è¯´æ˜æœ‰è¦†ç›–åˆä¼‘ â€” ç›´æ¥å‡å»1h
                    # æ›´ç²¾ç¡®æ–¹æ³•éœ€è¦ä¿ç•™åŸæ—¶æ®µæ•°æ®ï¼Œè¿™é‡Œç”¨ç®€åŒ–é€»è¾‘ï¼ˆå·²èƒ½è¦†ç›–å¸¸è§åœºæ™¯ï¼‰
                    if info['white_worked'] >= 1.0:  # æœ‰å·¥ä½œæ—¶é•¿åˆ™å¯èƒ½è¦†ç›–åˆä¼‘ï¼Œé‡‡ç”¨ä¿å®ˆå¤„ç†æ‰£1å°æ—¶ï¼ˆä»…åœ¨ç™½ç­æ®µå†…ï¼‰
                        # ä½†ç¡®ä¿ä¸å‡è´Ÿæ•°
                        reduce_lunch = 1.0 if info['white_worked'] >= 1.0 else 0.0
                        info['white_worked'] = max(0.0, info['white_worked'] - reduce_lunch)

                # ç´¯è®¡åˆ°æ€»é‡ï¼ˆå·¥èµ„å­—æ®µï¼‰
                worked_hours += info['white_worked']
                ot_weekday += info['white_ot16_19']
                ot_weekend += info['white_ot_weekend']
                ot_holiday += info['white_ot_holiday']
                night_regular += info['night_19_22']
                night_deep += info['night_22_03']
                night_ot += info['night_03_07']

                # ===== æ–°å¢ï¼šèŠ‚å‡æ—¥æ— æ¡ä»¶è¡¥å…… 8 å°æ—¶åˆ°å®é™…å·¥æ—¶ =====
                if info['is_holiday']:
                    worked_hours += 8.0
                    # ot_holiday += 8.0   # å¦‚æœæƒ³åŒæ—¶æŠŠ 8h è®¡åˆ°èŠ‚å‡æ—¥åŠ ç­ï¼Œå–æ¶ˆæ³¨é‡Š
                    print(f"[HrPayslip][{emp_name}] {info['date']} æ˜¯èŠ‚å‡æ—¥ï¼Œå·²è¡¥å…… 8.0 å°æ—¶åˆ°å®é™…å·¥æ—¶")

                # æ—¥å¿—ï¼šæŒ‰æ—¥æ‰“å°è¯¦æƒ…
                day_type = "èŠ‚å‡æ—¥" if info['is_holiday'] else ("å‘¨æ—¥" if info['is_sunday'] else "å·¥ä½œæ—¥")
                attendance_status = "æœ‰è€ƒå‹¤" if info['has_attendance'] else "æ— è€ƒå‹¤"
                print(
                    f"[HrPayslip][{emp_name}] {info['date']} ç±»å‹:{day_type} è€ƒå‹¤çŠ¶æ€:{attendance_status} "
                    f"ç™½ç­:{round(info['white_worked'], 2)}h + åŠ ç­(16-19):{round(info['white_ot16_19'], 2)}h "
                    f"å‘¨æœ«åŠ ç­:{round(info['white_ot_weekend'], 2)}h èŠ‚å‡æ—¥åŠ ç­:{round(info['white_ot_holiday'], 2)}h "
                    f"å¤œç­:19-22={round(info['night_19_22'], 2)}h 22-03={round(info['night_22_03'], 2)}h 03-07={round(info['night_03_07'], 2)}h "
                )

            # è®¡ç®—æ€»å‡ºå‹¤å°æ—¶æ•°å’Œå‡ºå‹¤ç‡
            total_attendance_hours = worked_hours + night_regular + night_deep

            # è®¡ç®—éœ€è¦å¸¦è–ªä¼‘å‡è¡¥é½çš„å°æ—¶æ•°
            if total_attendance_hours < standard_hours:
                paid_leave_hours_used = min(8.0, standard_hours - total_attendance_hours)
                total_attendance_hours += paid_leave_hours_used
                remaining_paid_leave_hours = 8.0 - paid_leave_hours_used
                print(f"[HrPayslip][{emp_name}] ğŸ’¼ ä½¿ç”¨å¸¦è–ªä¼‘å‡è¡¥é½: {round(paid_leave_hours_used, 2)}h")
            else:
                paid_leave_hours_used = 0.0
                remaining_paid_leave_hours = 8.0

            # è®¡ç®—å‡ºå‹¤ç‡
            if standard_hours > 0:
                attendance_rate = min(100.0, (total_attendance_hours / standard_hours) * 100)
            else:
                attendance_rate = 0.0

            # å†™å›å·¥èµ„å•å­—æ®µï¼ˆå››èˆäº”å…¥ï¼‰
            slip.standard_hours = round(standard_hours, 2)
            slip.worked_hours = round(worked_hours, 2)
            slip.ot_weekday = round(ot_weekday, 2)
            slip.ot_weekend = round(ot_weekend, 2)
            slip.ot_holiday = round(ot_holiday, 2)
            slip.night_regular = round(night_regular, 2)
            slip.night_deep = round(night_deep, 2)
            slip.night_ot = round(night_ot, 2)
            slip.attendance_rate = round(attendance_rate, 2)
            slip.remaining_paid_leave_hours = round(remaining_paid_leave_hours, 2)

            # æœ€ç»ˆæ—¥å¿—æ±‡æ€»
            print(
                f"[HrPayslip][{emp_name}] è®¡ç®—å®Œæˆ => æ ‡å‡†: {slip.standard_hours}h, å®é™…: {slip.worked_hours}h, "
                f"å·¥ä½œæ—¥åŠ ç­: {slip.ot_weekday}h, å‘¨æœ«åŠ ç­: {slip.ot_weekend}h, èŠ‚å‡æ—¥åŠ ç­: {slip.ot_holiday}h, "
                f"å¤œç­: {slip.night_regular}h, å¤œç­æ·±å¤œ: {slip.night_deep}h, å¤œç­åŠ ç­: {slip.night_ot}h"
            )
            print(
                f"[HrPayslip][{emp_name}] å®é™…å‡ºå‹¤ï¼š{slip.worked_hours+slip.night_regular+slip.night_deep} å‡ºå‹¤ç‡: {slip.attendance_rate}%,  å¸¦è–ªä¼‘å‡å‰©ä½™å°æ—¶æ•°: {slip.remaining_paid_leave_hours}h")

            # å¦‚æœæœ‰ä½¿ç”¨å¸¦è–ªä¼‘å‡ï¼Œè®°å½•è¯¦ç»†ä¿¡æ¯
            if paid_leave_hours_used > 0:
                print(f"[HrPayslip][{emp_name}] ğŸ“ å¸¦è–ªä¼‘å‡ä½¿ç”¨è¯¦æƒ…: "
                      f"å®é™…å·¥æ—¶{round(worked_hours + night_regular + night_deep, 2)}h + "
                      f"å¸¦è–ªä¼‘å‡{round(paid_leave_hours_used, 2)}h = "
                      f"æ€»å‡ºå‹¤{round(total_attendance_hours, 2)}h / æ ‡å‡†{standard_hours}h")


        return True

